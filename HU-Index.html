<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Juegos del Año — Pro</title>
<meta name="theme-color" content="#0b1220">
<style>
:root{
  --bg:#0b1220;--card:#11192b;--muted:#8ea0c2;--text:#e8eefc;--accent:#4ba3ff;--accent2:#26e6a4;--border:#1d2840;--row:#0f1730;--warn:#ffcf5a;--focus:#7cc0ff;--danger:#ff3b6b;
}
@media (prefers-color-scheme: light){
  :root{
    --bg:#f3f6fb;--card:#ffffff;--muted:#52607a;--text:#0d1b2a;--accent:#2563eb;--accent2:#06b6d4;--border:#d8e0ef;--row:#f6f8fd;--warn:#b08900;--focus:#2563eb;--danger:#d81b60;
  }
}
[data-theme="light"]{
  --bg:#f3f6fb;--card:#ffffff;--muted:#52607a;--text:#0d1b2a;--accent:#2563eb;--accent2:#06b6d4;--border:#d8e0ef;--row:#f6f8fd;--warn:#b08900;--focus:#2563eb;--danger:#d81b60;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
  color:var(--text);background:
    radial-gradient(1200px 600px at 10% -10%, #1a2440 0%, rgba(26,36,64,0) 60%),
    radial-gradient(800px 400px at 110% 10%, #12233e 0%, rgba(18,35,62,0) 60%),
    linear-gradient(180deg, #07101c, var(--bg));
  display:grid;place-items:stretch;padding:16px;
}
.wrap{width:min(1200px,100%);margin:0 auto;animation:fadeIn .5s ease both}
header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:12px;flex-wrap:wrap}
h1{font-size:clamp(22px,4vw,34px);letter-spacing:.2px;margin:0;font-weight:800;line-height:1.1}
.g{background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;background-clip:text;color:transparent}
p.lead{margin:6px 0 0;color:var(--muted);font-size:clamp(13px,2.2vw,15px)}
.dirty{display:inline-flex;align-items:center;gap:6px;background:rgba(255,207,90,.12);border:1px solid rgba(255,207,90,.35);color:var(--warn);
  padding:6px 10px;border-radius:999px;font-size:12px;white-space:nowrap;height:32px}
.toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin:12px 0}
.grp{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.input,.select,.btn{height:40px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--text);padding:0 12px;outline:none}
.input{width:260px}
.select{min-width:140px}
.btn{cursor:pointer;user-select:none}
.btn:disabled{opacity:.55;cursor:not-allowed}
.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;color:#08111e;font-weight:700}
.danger{border-color:#5b2330;background:rgba(255,0,76,.08);color:var(--danger);font-weight:600}
.ghost{background:transparent}
.tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.04);border:1px solid var(--border);font-size:12px;color:var(--muted)}
.card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.0));border:1px solid var(--border);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.20);overflow:hidden}
.row{display:grid;grid-template-columns:1fr;gap:12px}
.stats{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;padding:10px}
.stat{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:12px;padding:10px}
.stat h3{margin:0 0 6px 0;font-size:12px;color:var(--muted);font-weight:600}
.stat .v{font-size:20px;font-weight:800}
.chart{height:42px;width:100%}
.table-wrap{overflow:auto}
table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
thead th{
  position:sticky;top:0;background:rgba(8,15,30,.9);backdrop-filter:saturate(140%) blur(6px);
  text-align:left;font-size:13px;color:var(--muted);font-weight:700;border-bottom:1px solid var(--border);padding:12px;white-space:nowrap;user-select:none;
}
thead th.sort{cursor:pointer}
thead th[aria-sort="ascending"]::after{content:" ▲";font-weight:700}
thead th[aria-sort="descending"]::after{content:" ▼";font-weight:700}
thead th .res{position:absolute;right:0;top:0;height:100%;width:6px;cursor:col-resize}
tbody td{padding:12px;border-bottom:1px solid var(--border);vertical-align:middle;overflow:hidden;text-overflow:ellipsis}
tbody tr{background:linear-gradient(180deg,rgba(255,255,255,.01),rgba(255,255,255,0))}
tbody tr:hover{background:linear-gradient(180deg,rgba(75,163,255,.08),rgba(38,230,164,.05))}
tbody tr.sel{outline:2px solid var(--focus);outline-offset:-2px}
td.actions{width:1%;white-space:nowrap}
input.cell, select.cell{
  height:32px;width:100%;border-radius:8px;border:1px solid var(--border);background:rgba(255,255,255,.05);color:var(--text);padding:0 8px;outline:none
}
mark{background:transparent;color:inherit;position:relative}
mark::before{content:"";position:absolute;inset:0 0 -.1em 0;background:linear-gradient(90deg,rgba(75,163,255,.35),rgba(38,230,164,.25));filter:blur(6px);z-index:-1;border-radius:4px}
.footer{display:flex;justify-content:space-between;gap:8px;padding:10px;border-top:1px solid var(--border);background:rgba(9,14,28,.5);color:var(--muted);font-size:12px}
.pager{display:flex;gap:6px;align-items:center}
.pager .btn{height:32px}
.kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:6px;padding:2px 6px}
.toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.75);color:#fff;padding:10px 14px;border-radius:10px;font-size:13px;opacity:0;pointer-events:none;transition:opacity .2s}
.toast.show{opacity:1}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
@media (max-width:900px){.stats{grid-template-columns:repeat(2,minmax(0,1fr))}}
@media print{
  body{background:#fff;color:#000}
  .toolbar,.footer,.toast,[data-no-print]{display:none!important}
  .card{box-shadow:none;border:none}
  thead th{position:static;background:#eee;color:#000}
}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1><span class="g">¡Bienvenido!</span> Panel avanzado de <em>Juegos del Año</em></h1>
      <p class="lead">Búsqueda, filtros, edición, orden, estadísticas, exportación, deshacer/rehacer, selección múltiple, tema y modo offline.</p>
    </div>
    <div class="grp">
      <span id="dirty" class="dirty" hidden>Cambios sin guardar</span>
      <button id="theme" class="btn">Tema</button>
    </div>
  </header>

  <section class="card" role="region" aria-labelledby="titulo">
    <div class="toolbar" data-no-print>
      <div class="grp">
        <input id="q" class="input" type="search" placeholder="Buscar por juego, estudio, género o plataforma" aria-label="Buscar" />
        <select id="year" class="select" aria-label="Filtrar por año"></select>
        <select id="perPage" class="select" aria-label="Filas por página">
          <option>10</option><option>25</option><option selected>50</option><option>100</option>
        </select>
        <span id="count" class="tag" aria-live="polite"></span>
      </div>
      <div class="grp">
        <button id="add" class="btn">Añadir</button>
        <button id="bulkDel" class="btn danger" disabled>Eliminar seleccionados</button>
        <button id="importCsv" class="btn">Importar CSV</button>
        <button id="importJson" class="btn">Importar JSON</button>
        <button id="paste" class="btn">Pegar</button>
        <button id="exportCsv" class="btn">CSV</button>
        <button id="exportJson" class="btn">JSON</button>
        <button id="undo" class="btn ghost" disabled>Deshacer</button>
        <button id="redo" class="btn ghost" disabled>Rehacer</button>
        <button id="reset" class="btn danger">Restablecer</button>
        <button id="save" class="btn primary">Guardar</button>
        <input id="file" type="file" accept=".csv,.json,text/csv,application/json" hidden />
      </div>
    </div>

    <div class="row">
      <div class="stats" aria-live="polite">
        <div class="stat"><h3>Total filas</h3><div id="stTotal" class="v">0</div><canvas id="chTotal" class="chart"></canvas></div>
        <div class="stat"><h3>Años únicos</h3><div id="stYears" class="v">0</div><canvas id="chYears" class="chart"></canvas></div>
        <div class="stat"><h3>Último lanzamiento</h3><div id="stLast" class="v">—</div><canvas id="chLast" class="chart"></canvas></div>
        <div class="stat"><h3>Puntuación media</h3><div id="stScore" class="v">—</div><canvas id="chScore" class="chart"></canvas></div>
      </div>

      <div class="table-wrap">
        <table id="grid" aria-label="Tabla Juegos del Año">
          <thead>
            <tr>
              <th style="width:44px"><input type="checkbox" id="chkAll" aria-label="Seleccionar todo"></th>
              <th data-key="anio" class="sort" aria-sort="none">Año<div class="res"></div></th>
              <th data-key="juego" class="sort" aria-sort="none">Juego<div class="res"></div></th>
              <th data-key="estudio" class="sort" aria-sort="none">Estudio<div class="res"></div></th>
              <th data-key="genero" class="sort" aria-sort="none">Género<div class="res"></div></th>
              <th data-key="plataformas" class="sort" aria-sort="none">Plataformas<div class="res"></div></th>
              <th data-key="lanzamiento" class="sort" aria-sort="none">Lanzamiento<div class="res"></div></th>
              <th data-key="puntuacion" class="sort" aria-sort="none">Puntuación<div class="res"></div></th>
              <th class="actions" aria-hidden="true">Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="footer" data-no-print>
        <div>
          <small>Atajos: <span class="kbd">Enter</span> editar, <span class="kbd">Esc</span> cancelar, <span class="kbd">Ctrl/⌘+S</span> guardar, <span class="kbd">Ctrl/⌘+Z</span> deshacer, <span class="kbd">Ctrl/⌘+Y</span> rehacer.</small>
        </div>
        <div class="pager">
          <button id="prev" class="btn">◀</button>
          <span id="pageInfo" class="tag"></span>
          <button id="next" class="btn">▶</button>
        </div>
      </div>
    </div>
  </section>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
const storageKey="goty-pro-v1";
const backupKey="goty-pro-v1-backups";
const themeKey="goty-theme";
const $=(s,el=document)=>el.querySelector(s);
const $$=(s,el=document)=>[...el.querySelectorAll(s)];
const fmtDate=d=>isNaN(d)?"" : new Date(d).toISOString().slice(0,10);
const rank=s=>({ "Bajo":1,"Medio":2,"Alto":3,"Obra maestra":4 }[String(s).trim()]||0);
const unrank=n=>({1:"Bajo",2:"Medio",3:"Alto",4:"Obra maestra"}[n]||"");
const toast=(m,t=1800)=>{const x=$("#toast");x.textContent=m;x.classList.add("show");setTimeout(()=>x.classList.remove("show"),t);};
const cryptoId=()=> 'r'+Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(-4);

const seed=[
  {id:cryptoId(), anio:2025, juego:"", estudio:"", genero:"", plataformas:"", lanzamiento:"", puntuacion:""},
  {id:cryptoId(), anio:2024, juego:"", estudio:"", genero:"", plataformas:"", lanzamiento:"", puntuacion:""},
  {id:cryptoId(), anio:2023, juego:"Baldur's Gate 3", estudio:"Larian Studios", genero:"RPG", plataformas:"PC, PS5, XSX|S", lanzamiento:"2023-08-03", puntuacion:"Alto"},
  {id:cryptoId(), anio:2022, juego:"Elden Ring", estudio:"FromSoftware", genero:"ARPG", plataformas:"PC, PS, Xbox", lanzamiento:"2022-02-25", puntuacion:"Alto"}
];

let data=load(storageKey)||seed.slice();
let edited=false;
let sort={key:null,dir:1};
let selection=new Set();
let page=1, perPage=Number($("#perPage").value||50);
let undoStack=[], redoStack=[];
let dragCol=null, dragStartX=0, startWidth=0;
let headerOrder = load("goty-pro-v1-cols") || ["select","anio","juego","estudio","genero","plataformas","lanzamiento","puntuacion","acciones"];

function save(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
function load(k){ try{ return JSON.parse(localStorage.getItem(k)); }catch{ return null; } }
function setDirty(v){ edited=!!v; $("#dirty").hidden=!edited; }
function backup(){ const b=load(backupKey)||[]; b.unshift({ts:Date.now(),data}); save(backupKey,b.slice(0,5)); }
function pushUndo(){ undoStack.push(JSON.stringify(data)); redoStack.length=0; updateUndoRedo(); }
function updateUndoRedo(){ $("#undo").disabled=!undoStack.length; $("#redo").disabled=!redoStack.length; }
function uniqueYears(){ return [...new Set(data.map(r=>Number(r.anio)||0))].filter(Boolean).sort((a,b)=>b-a); }
function fillYears(){ const years=["Todos",...uniqueYears()]; const y=$("#year"); y.innerHTML=years.map(v=>`<option value="${v}">${v}</option>`).join(""); if(!years.includes(y.value)) y.value="Todos"; }
function debounce(fn,ms=200){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

function filterSortRows(){
  const term=$("#q").value.trim().toLowerCase(); const yf=$("#year").value;
  let rows=data.filter(r=> (yf==="Todos"|| String(r.anio)===String(yf)) && (!term || Object.values(r).some(v=>String(v).toLowerCase().includes(term))));
  if(sort.key){
    rows=rows.slice().sort((a,b)=> sort.dir*cmp(a,b,sort.key));
  }
  return rows;
}
function cmp(a,b,key){
  if(key==="anio") return (Number(a.anio)||0)-(Number(b.anio)||0);
  if(key==="lanzamiento") return new Date(a.lanzamiento||0)-new Date(b.lanzamiento||0);
  if(key==="puntuacion") return rank(a.puntuacion)-rank(b.puntuacion);
  return String(a[key]??"").localeCompare(String(b[key]??""),'es',{numeric:true,sensitivity:'base'});
}
function highlight(t,term){
  if(!term) return t;
  const esc=term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  return t.replace(new RegExp(`(${esc})`,'ig'),'<mark>$1</mark>');
}
function pageRows(rows){
  const total=rows.length, pages=Math.max(1,Math.ceil(total/perPage));
  if(page>pages) page=pages;
  const start=(page-1)*perPage;
  return {slice: rows.slice(start,start+perPage), total, pages};
}
function render(){
  perPage=Number($("#perPage").value)||50;
  const term=$("#q").value.trim();
  const rows=filterSortRows();
  const {slice,total,pages}=pageRows(rows);
  const tb=$("#grid tbody");
  tb.innerHTML = slice.map(r=>{
    return `<tr data-id="${r.id}" class="${selection.has(r.id)?'sel':''}">
      <td><input type="checkbox" class="chk" ${selection.has(r.id)?'checked':''} aria-label="Seleccionar fila"></td>
      <td data-key="anio" data-type="number" tabindex="0">${highlight(String(r.anio??""),term)}</td>
      <td data-key="juego" tabindex="0">${highlight(String(r.juego??""),term)}</td>
      <td data-key="estudio" tabindex="0">${highlight(String(r.estudio??""),term)}</td>
      <td data-key="genero" tabindex="0">${highlight(String(r.genero??""),term)}</td>
      <td data-key="plataformas" tabindex="0">${highlight(String(r.plataformas??""),term)}</td>
      <td data-key="lanzamiento" data-type="date" tabindex="0">${highlight(String(r.lanzamiento??""),term)}</td>
      <td data-key="puntuacion" data-type="select" tabindex="0">${highlight(String(r.puntuacion??""),term)}</td>
      <td class="actions">
        <button class="btn ghost btnUp" title="Subir">↑</button>
        <button class="btn ghost btnDown" title="Bajar">↓</button>
        <button class="btn danger btnDel" title="Eliminar">Eliminar</button>
      </td>
    </tr>`;
  }).join("");

  $("#count").textContent=`${total} filas • ${data.length} en total`;
  $("#pageInfo").textContent=`Página ${page}/${pages}`;
  $("#prev").disabled=page<=1; $("#next").disabled=page>=pages;
  $("#bulkDel").disabled=!selection.size;
  renderStats();
  renderHeaderOrder();
  updateUndoRedo();
}
function renderHeaderOrder(){
  const ths=$$("#grid thead th");
  ths.forEach(th=>{
    const k=th.dataset.key;
    if(!k) return;
    th.setAttribute("aria-sort", k===sort.key ? (sort.dir===1?"ascending":"descending") : "none");
  });
}
function setStatus(msg){ toast(msg,1500); }

function editCell(td){
  if(td.querySelector('.cell')) return;
  const tr=td.closest('tr'); const id=tr.dataset.id; const key=td.dataset.key; if(!key) return;
  const type=td.dataset.type||'text'; const old=td.textContent.trim();
  let ed;
  if(type==='select'){
    ed=document.createElement('select'); ed.className='cell';
    ['', 'Bajo','Medio','Alto','Obra maestra'].forEach(v=>{
      const o=document.createElement('option'); o.value=v; o.textContent=v||'(vacío)'; if(v===old) o.selected=true; ed.appendChild(o);
    });
  }else if(type==='date'){
    ed=document.createElement('input'); ed.type='date'; ed.className='cell';
    ed.value=/^\d{4}-\d{2}-\d{2}$/.test(old)?old:'';
  }else if(type==='number'){
    ed=document.createElement('input'); ed.type='number'; ed.className='cell'; ed.min=1970; ed.max=2100; ed.step=1; ed.value=old||new Date().getFullYear();
  }else{
    ed=document.createElement('input'); ed.type='text'; ed.className='cell'; ed.value=old;
  }
  td.innerHTML=''; td.appendChild(ed); ed.focus(); ed.select();
  const commit=()=>{
    let v=(ed.value??'').trim();
    if(type==='number') v=Number(v||new Date().getFullYear());
    if(key==='lanzamiento' && v && !/^\d{4}-\d{2}-\d{2}$/.test(v)){ const d=new Date(v); if(!isNaN(d)) v=fmtDate(d); }
    if(key==='anio' && (v<1970||v>2100)){ toast("Año fuera de rango"); td.innerHTML=old; return; }
    updateRow(id,key,v);
  };
  const cancel=()=>{ td.textContent=old; };
  ed.addEventListener('keydown',e=>{
    if(e.key==='Enter'){ e.preventDefault(); commit(); }
    if(e.key==='Escape'){ e.preventDefault(); cancel(); }
  });
  ed.addEventListener('blur',commit);
}
function updateRow(id,key,val){
  const i=data.findIndex(x=>x.id===id); if(i<0) return;
  pushUndo();
  data[i][key]=val;
  setDirty(true);
  render();
}
function addRow(){
  pushUndo();
  const y=new Date().getFullYear();
  data.unshift({id:cryptoId(), anio:y, juego:"", estudio:"", genero:"", plataformas:"", lanzamiento:"", puntuacion:""});
  setDirty(true);
  page=1; render();
}
function delRow(id){
  const i=data.findIndex(x=>x.id===id); if(i<0) return;
  pushUndo(); data.splice(i,1); selection.delete(id); setDirty(true); render();
}
function moveRow(id,dir){
  const i=data.findIndex(x=>x.id===id); if(i<0) return;
  const j=i+dir; if(j<0||j>=data.length) return;
  pushUndo(); const [r]=data.splice(i,1); data.splice(j,0,r); setDirty(true); render();
}
function csvEscape(s){ return `"${String(s??"").replace(/"/g,'""')}"`; }
function exportCSV(){
  const cols=["anio","juego","estudio","genero","plataformas","lanzamiento","puntuacion"];
  const lines=[cols.join(",")].concat(data.map(r=>cols.map(c=>csvEscape(r[c])).join(",")));
  download(new Blob([lines.join("\n")],{type:"text/csv;charset=utf-8;"}),"juegos.csv");
  setStatus("CSV exportado");
}
function exportJSON(){
  download(new Blob([JSON.stringify(data,null,2)],{type:"application/json"}),"juegos.json");
  setStatus("JSON exportado");
}
function download(blob, name){
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href);
}
function parseCSV(txt){
  const rows=[]; const lines=txt.replace(/\r/g,"").split("\n").filter(Boolean);
  let headers=[];
  if(lines.length){
    headers=splitCSV(lines[0]).map(h=>h.trim());
    for(let i=1;i<lines.length;i++){
      const cells=splitCSV(lines[i]); const r={};
      headers.forEach((h,ix)=>r[h]=cells[ix]??"");
      rows.push(r);
    }
  }
  return rows;
}
function splitCSV(line){
  const out=[]; let cur="", inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='"' ){ if(inQ && line[i+1]==='"'){ cur+='"'; i++; } else inQ=!inQ; }
    else if(ch===',' && !inQ){ out.push(cur); cur=""; }
    else cur+=ch;
  }
  out.push(cur); return out;
}
function importRows(rows){
  const norm=rows.map(r=>({
    id:cryptoId(),
    anio:Number(r.anio||r.Año||r.year||r.Year)||new Date().getFullYear(),
    juego:r.juego||r.Juego||r.title||r.Title||"",
    estudio:r.estudio||r.Estudio||r.studio||r.Studio||"",
    genero:r.genero||r.Género||r.genre||r.Genre||"",
    plataformas:r.plataformas||r.Plataformas||r.platforms||r.Platforms||"",
    lanzamiento: r.lanzamiento||r.Lanzamiento||r.release||r.Release||"",
    puntuacion: r.puntuacion||r.Puntuación||r.score||r.Score||""
  }));
  pushUndo();
  data = norm.concat(data);
  setDirty(true); fillYears(); render(); setStatus(`Importadas ${norm.length} filas`);
}
function pastePlain(){
  navigator.clipboard.readText().then(txt=>{
    try{
      if(txt.trim().startsWith("{")||txt.trim().startsWith("[")){
        const arr=JSON.parse(txt); if(Array.isArray(arr)) importRows(arr); else importRows([arr]);
      }else{
        const rows=parseCSV(txt); importRows(rows);
      }
    }catch(e){ toast("No se pudo pegar"); }
  }).catch(()=>toast("Permite acceso al portapapeles"));
}
function saveAll(){
  backup();
  save(storageKey,data);
  setDirty(false);
  setStatus("Guardado");
}
function resetAll(){
  if(edited && !confirm("Perderás cambios no guardados. ¿Continuar?")) return;
  pushUndo();
  data=seed.map(r=>({...r,id:cryptoId()}));
  setDirty(true); selection.clear(); page=1; fillYears(); render();
}
function undo(){
  if(!undoStack.length) return;
  const prev=undoStack.pop(); redoStack.push(JSON.stringify(data)); data=JSON.parse(prev);
  setDirty(true); render(); updateUndoRedo();
}
function redo(){
  if(!redoStack.length) return;
  const next=redoStack.pop(); undoStack.push(JSON.stringify(data)); data=JSON.parse(next);
  setDirty(true); render(); updateUndoRedo();
}
function toggleTheme(){
  const cur=document.documentElement.getAttribute("data-theme");
  const next=cur==="light" ? "" : "light";
  if(next) document.documentElement.setAttribute("data-theme","light");
  else document.documentElement.removeAttribute("data-theme");
  save(themeKey, next||"dark");
}
function applyTheme(){
  const t=load(themeKey);
  if(t==="light") document.documentElement.setAttribute("data-theme","light");
}
function updateStatsSeries(vals, id){
  const c=$(id); const ctx=c.getContext("2d"); const w=c.width=c.clientWidth, h=c.height=c.clientHeight;
  ctx.clearRect(0,0,w,h);
  if(!vals.length) return;
  const min=Math.min(...vals), max=Math.max(...vals);
  const scale=v=> h - (h*(v-min)/(max-min||1));
  ctx.beginPath();
  vals.forEach((v,i)=>{
    const x = i*(w/(vals.length-1||1));
    const y = scale(v);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.lineWidth=2; ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent'); ctx.stroke();
}
function renderStats(){
  $("#stTotal").textContent=String(data.length);
  $("#stYears").textContent=String(uniqueYears().length);
  const last = data.map(r=> new Date(r.lanzamiento||0).getTime() || 0).filter(Boolean).sort((a,b)=>b-a)[0];
  $("#stLast").textContent= last? fmtDate(last) : "—";
  const mean = data.length ? (data.map(r=>rank(r.puntuacion)).reduce((a,b)=>a+b,0)/data.length) : 0;
  $("#stScore").textContent= mean ? unrank(Math.round(mean)) : "—";
  updateStatsSeries([data.length], "#chTotal");
  updateStatsSeries([uniqueYears().length], "#chYears");
  updateStatsSeries(data.map(r=> new Date(r.lanzamiento||0).getFullYear()||0).filter(Boolean).slice(-24), "#chLast");
  updateStatsSeries(data.map(r=>rank(r.puntuacion)||0).slice(-24), "#chScore");
}
function currentSliceIds(){
  return pageRows(filterSortRows()).slice.map(r=>r.id);
}

/* Column resize */
$("#grid thead").addEventListener('mousedown', e=>{
  const res=e.target.closest('.res'); if(!res) return;
  const th=res.parentElement; dragCol=th; dragStartX=e.clientX; startWidth=th.offsetWidth;
  document.addEventListener('mousemove', onColDrag); document.addEventListener('mouseup', stopColDrag);
});
function onColDrag(e){
  if(!dragCol) return;
  const dx=e.clientX-dragStartX; const w=Math.max(60, startWidth+dx);
  dragCol.style.width=w+"px";
}
function stopColDrag(){ dragCol=null; document.removeEventListener('mousemove', onColDrag); document.removeEventListener('mouseup', stopColDrag); }

/* Header sort + drag re-order (simple hold+Alt to reorder) */
let dragReorder=null, dragIndex=-1;
$("#grid thead").addEventListener('click', e=>{
  const th=e.target.closest('th.sort'); if(!th || e.altKey) return;
  const k=th.dataset.key; if(!k) return;
  if(sort.key===k) sort.dir=-sort.dir; else { sort.key=k; sort.dir=1; }
  render();
});
$("#grid thead").addEventListener('mousedown', e=>{
  if(!e.altKey) return;
  const ths=$$("#grid thead th"); const th=e.target.closest('th'); if(!th) return;
  dragReorder=th; dragIndex=ths.indexOf(th);
  document.addEventListener('mouseup', onHdrUp);
});
$("#grid thead").addEventListener('mousemove', e=>{
  if(!dragReorder) return;
  const ths=$$("#grid thead th"); const over=e.target.closest('th'); if(!over) return;
  const i=ths.indexOf(over);
  if(i!==-1 && i!==dragIndex){
    const tr=$("#grid thead tr"); tr.insertBefore(dragReorder, i>dragIndex? over.nextSibling : over);
    dragIndex=i;
  }
});
function onHdrUp(){
  document.removeEventListener('mouseup', onHdrUp);
  if(!dragReorder) return;
  headerOrder = $$("#grid thead th").map(th=> th.dataset.key|| (th.querySelector('input')?'select':'acciones'));
  save("goty-pro-v1-cols", headerOrder);
  dragReorder=null; render();
}

/* Body interactions */
$("#grid tbody").addEventListener('dblclick', e=>{
  const td=e.target.closest('td[data-key]'); if(td) editCell(td);
});
$("#grid tbody").addEventListener('keydown', e=>{
  const td=e.target.closest('td[data-key]'); if(!td) return;
  if(e.key==='Enter'){ e.preventDefault(); editCell(td); }
  if(e.key==='ArrowDown' || e.key==='ArrowUp'){
    e.preventDefault();
    const cells=$$("#grid tbody td[data-key]");
    const i=cells.indexOf(td); const j=i+(e.key==='ArrowDown'?+1:-1);
    if(cells[j]) cells[j].focus();
  }
});
$("#grid tbody").addEventListener('click', e=>{
  const tr=e.target.closest('tr'); if(!tr) return;
  const id=tr.dataset.id;
  if(e.target.classList.contains('chk')){
    if(e.target.checked) selection.add(id); else selection.delete(id);
    $("#bulkDel").disabled=!selection.size;
    tr.classList.toggle('sel', e.target.checked);
    return;
  }
  if(e.target.classList.contains('btnDel')){ delRow(id); return; }
  if(e.target.classList.contains('btnUp')){ moveRow(id,-1); return; }
  if(e.target.classList.contains('btnDown')){ moveRow(id,+1); return; }
});

/* Select all */
$("#chkAll").addEventListener('change', e=>{
  const ids=currentSliceIds();
  if(e.target.checked) ids.forEach(id=>selection.add(id)); else ids.forEach(id=>selection.delete(id));
  render();
});
$("#bulkDel").addEventListener('click', ()=>{
  if(!selection.size) return;
  if(!confirm(`Eliminar ${selection.size} filas seleccionadas?`)) return;
  pushUndo();
  data=data.filter(r=>!selection.has(r.id));
  selection.clear(); setDirty(true); render();
});

/* Toolbar */
$("#add").addEventListener('click', addRow);
$("#exportCsv").addEventListener('click', exportCSV);
$("#exportJson").addEventListener('click', exportJSON);
$("#importCsv").addEventListener('click', ()=>{ $("#file").accept=".csv,text/csv"; $("#file").click(); });
$("#importJson").addEventListener('click', ()=>{ $("#file").accept=".json,application/json"; $("#file").click(); });
$("#file").addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      if(f.type.includes('json') || f.name.endsWith('.json')){ const arr=JSON.parse(r.result); importRows(Array.isArray(arr)?arr:[arr]); }
      else{ importRows(parseCSV(r.result)); }
    }catch(err){ toast("Archivo inválido"); }
    e.target.value="";
  };
  r.readAsText(f);
});
$("#paste").addEventListener('click', pastePlain);
$("#save").addEventListener('click', saveAll);
$("#reset").addEventListener('click', resetAll);
$("#undo").addEventListener('click', undo);
$("#redo").addEventListener('click', redo);

/* Filters & paging */
$("#q").addEventListener('input', debounce(()=>{ page=1; render(); },160));
$("#year").addEventListener('change', ()=>{ page=1; render(); });
$("#perPage").addEventListener('change', ()=>{ page=1; render(); });
$("#prev").addEventListener('click', ()=>{ if(page>1){ page--; render(); }});
$("#next").addEventListener('click', ()=>{ page++; render(); });

/* Keyboard global */
document.addEventListener('keydown', e=>{
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); saveAll(); }
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='z'){ e.preventDefault(); undo(); }
  if((e.ctrlKey||e.metaKey) && (e.key.toLowerCase()==='y' || (e.shiftKey && e.key.toLowerCase()==='z'))){ e.preventDefault(); redo(); }
});

/* Theme */
$("#theme").addEventListener('click', toggleTheme); applyTheme();

/* Autosave */
let autosave=debounce(()=>{ if(edited){ save(storageKey,data); backup(); } }, 1000);
const prox=new Proxy({},{set(_,p,v){ if(p==="change"){ autosave(); setDirty(true); } return true; }});
const _setDirty=setDirty;
setDirty=(v)=>{ _setDirty(v); if(v) prox.change=true; };

/* Offline SW from same file */
if('serviceWorker' in navigator){
  const swCode=`
  const C= 'goty-pro-cache-v1';
  self.addEventListener('install', e=>{ e.waitUntil(caches.open(C).then(c=>c.addAll(['./']))); self.skipWaiting(); });
  self.addEventListener('activate', e=>{ e.waitUntil(self.clients.claim()); });
  self.addEventListener('fetch', e=>{
    const req=e.request;
    if(req.method!=='GET') return;
    e.respondWith(
      caches.match(req).then(r=> r || fetch(req).then(resp=>{
        const copy=resp.clone();
        caches.open(C).then(c=>c.put(req, copy)).catch(()=>{});
        return resp;
      }).catch(()=>r))
    );
  });
  `;
  const blob=new Blob([swCode],{type:"text/javascript"});
  const url=URL.createObjectURL(blob);
  navigator.serviceWorker.getRegistration().then(reg=>{
    if(!reg) navigator.serviceWorker.register(url);
  });
}

/* Init */
fillYears(); render();
</script>
</body>
</html>
